<?php
/**
 * MIGRATION SCRIPT: Hash Existing Plaintext Passwords
 * 
 * INSTRUKSI:
 * 1. Upload file ini ke root folder web Anda
 * 2. Akses via browser: http://localhost/migrate_passwords.php
 * 3. Script akan otomatis hash semua password plaintext
 * 4. HAPUS file ini setelah selesai migrasi untuk keamanan
 */

require 'config.php';

// Password untuk menjalankan script (ganti dengan password aman Anda)
define('MIGRATION_PASSWORD', 'migrate2024');

$authenticated = false;
$results = [];

// Cek autentikasi
if (isset($_POST['auth_password'])) {
    if ($_POST['auth_password'] === MIGRATION_PASSWORD) {
        $authenticated = true;
    } else {
        $error = "Password salah!";
    }
}

// Proses migrasi jika sudah authenticated
if ($authenticated) {
    
    // Ambil semua user
    $users = $conn->query("SELECT id, nim_nip, name, password FROM users");
    
    $total = 0;
    $hashed = 0;
    $skipped = 0;
    
    while ($user = $users->fetch_assoc()) {
        $total++;
        
        // Cek apakah password sudah di-hash
        if (substr($user['password'], 0, 4) === '$2y$' || substr($user['password'], 0, 4) === '$2a$') {
            $skipped++;
            $results[] = [
                'nim_nip' => $user['nim_nip'],
                'name' => $user['name'],
                'status' => '‚úÖ Sudah di-hash',
                'action' => 'Dilewati'
            ];
        } else {
            // Hash password plaintext
            $new_hash = password_hash($user['password'], PASSWORD_DEFAULT);
            
            $stmt = $conn->prepare("UPDATE users SET password = ? WHERE id = ?");
            $stmt->bind_param("si", $new_hash, $user['id']);
            
            if ($stmt->execute()) {
                $hashed++;
                $results[] = [
                    'nim_nip' => $user['nim_nip'],
                    'name' => $user['name'],
                    'status' => 'üîí Berhasil di-hash',
                    'action' => 'Diupdate'
                ];
            } else {
                $results[] = [
                    'nim_nip' => $user['nim_nip'],
                    'name' => $user['name'],
                    'status' => '‚ùå Gagal',
                    'action' => 'Error: ' . $stmt->error
                ];
            }
            
            $stmt->close();
        }
    }
}
?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Migration Script</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 2rem;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        h1 {
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            margin-bottom: 1rem;
        }
        .warning {
            background: #ff4444;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            font-weight: bold;
        }
        .info {
            background: #444;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #00ff00;
        }
        .success {
            background: #004400;
            color: #00ff00;
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border: 2px solid #00ff00;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: #1a1a1a;
        }
        th, td {
            padding: 0.8rem;
            text-align: left;
            border: 1px solid #444;
        }
        th {
            background: #333;
            color: #00ff00;
            font-weight: bold;
        }
        input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            background: #1a1a1a;
            border: 2px solid #00ff00;
            color: #00ff00;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
        }
        button {
            background: #00ff00;
            color: #1a1a1a;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            margin-top: 1rem;
        }
        button:hover {
            background: #00cc00;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .stat-box {
            background: #333;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #00ff00;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff00;
        }
        .error {
            background: #ff4444;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Password Migration Script</h1>
        
        <div class="warning">
            ‚ö†Ô∏è PERHATIAN: Script ini akan mengubah semua password plaintext menjadi hash yang aman.
            Pastikan Anda sudah backup database sebelum melanjutkan!
        </div>

        <?php if (!$authenticated): ?>
            
            <div class="info">
                <h3>Instruksi:</h3>
                <ol>
                    <li>Pastikan Anda sudah backup database</li>
                    <li>Masukkan password migrasi (default: <code>migrate2024</code>)</li>
                    <li>Klik tombol "Mulai Migrasi"</li>
                    <li>Setelah selesai, HAPUS file ini dari server</li>
                </ol>
            </div>

            <?php if (isset($error)): ?>
                <div class="error"><?= $error ?></div>
            <?php endif; ?>

            <form method="POST">
                <label for="auth_password">Password Migrasi:</label>
                <input type="password" name="auth_password" id="auth_password" required autofocus>
                <button type="submit">üöÄ Mulai Migrasi</button>
            </form>

        <?php else: ?>

            <div class="success">
                <h2>‚úÖ Migrasi Selesai!</h2>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number"><?= $total ?></div>
                        <div>Total User</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><?= $hashed ?></div>
                        <div>Berhasil Di-hash</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number"><?= $skipped ?></div>
                        <div>Sudah Di-hash</div>
                    </div>
                </div>
            </div>

            <h3>Detail Hasil:</h3>
            <table>
                <thead>
                    <tr>
                        <th>NIM/NIP</th>
                        <th>Nama</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($results as $result): ?>
                        <tr>
                            <td><?= htmlspecialchars($result['nim_nip']) ?></td>
                            <td><?= htmlspecialchars($result['name']) ?></td>
                            <td><?= $result['status'] ?></td>
                            <td><?= htmlspecialchars($result['action']) ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <div class="warning" style="margin-top: 2rem;">
                üî• PENTING: Sekarang HAPUS file migrate_passwords.php ini dari server untuk keamanan!
            </div>

        <?php endif; ?>

    </div>
</body>
</html>